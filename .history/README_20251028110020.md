# DevOps Stage 2 - Blue/Green Deployment with Nginx

## Overview
This project implements a Blue/Green deployment pattern with automatic failover using Nginx and Docker Compose. When the primary (Blue) service fails, Nginx automatically routes traffic to the backup (Green) service with zero downtime.

## Architecture
- **Nginx**: Reverse proxy with automatic failover (port 8080)
- **Blue App**: Primary application instance (port 8081)
- **Green App**: Backup application instance (port 8082)

## Prerequisites
- Docker 20.10 or higher
- Docker Compose 1.29 or higher
- curl (for testing)

## Quick Start

### 1. Clone the repository
```bash
git clone https://github.com/YOUR_USERNAME/devops-stage2.git
cd devops-stage2
```

### 2. Configure environment
```bash
cp .env.example .env
```

The default `.env` should work without modifications:
```env
BLUE_IMAGE=yimikaade/wonderful:devops-stage-two
GREEN_IMAGE=yimikaade/wonderful:devops-stage-two
ACTIVE_POOL=blue
RELEASE_ID_BLUE=blue-v1.0.0
RELEASE_ID_GREEN=green-v1.0.0
PORT=3000
```

### 3. Start the services
```bash
docker-compose up -d
```

### 4. Verify deployment
```bash
# Check all services are running
docker-compose ps

# Should show 3 containers running:
# - devops-nginx
# - devops-app-blue
# - devops-app-green
```

## Testing

### Basic Functionality Test
```bash
# Test Blue directly (should return 200)
curl -i http://localhost:8081/version

# Test Green directly (should return 200)
curl -i http://localhost:8082/version

# Test through Nginx (should route to Blue)
curl -i http://localhost:8080/version
```

**Expected output:**
```
HTTP/1.1 200 OK
X-App-Pool: blue
X-Release-Id: blue-v1.0.0
...
```

### Failover Test

#### Step 1: Verify Blue is active
```bash
curl http://localhost:8080/version
# Should show: X-App-Pool: blue
```

#### Step 2: Trigger chaos on Blue
```bash
curl -X POST http://localhost:8081/chaos/start?mode=error
```

#### Step 3: Test automatic failover
```bash
# Run multiple requests
for i in {1..10}; do
  curl -s http://localhost:8080/version | grep pool
  sleep 0.5
done

# Should show: "pool":"green" for all requests
# All should be HTTP 200 (zero failures)
```

#### Step 4: Stop chaos and recover
```bash
curl -X POST http://localhost:8081/chaos/stop
sleep 5

# Traffic should return to Blue
curl http://localhost:8080/version
# Should show: X-App-Pool: blue
```

### Automated Test Script

Run the complete test suite:
```bash
chmod +x test-failover.sh
./test-failover.sh
```

**Expected results:**
- ✅ 100% success rate (all 200 responses)
- ✅ ≥95% Green routing during failure (typically 100%)
- ✅ Zero client-facing errors

## How It Works

### Normal Operation
1. All traffic goes to Blue (primary)
2. Green stands by as backup
3. Nginx monitors Blue's health

### During Failure
1. Blue starts returning 5xx errors or timeouts
2. Nginx detects failure within 2 seconds
3. Nginx automatically retries request to Green
4. Client receives 200 response (no error)
5. All subsequent traffic goes to Green

### Recovery
1. Blue recovers and starts responding normally
2. After `fail_timeout` (5s), Nginx marks Blue as healthy
3. Traffic returns to Blue (primary)

## Configuration Details

### Nginx Settings
- `max_fails=2`: Mark upstream down after 2 failures
- `fail_timeout=5s`: Keep marked down for 5 seconds
- `proxy_read_timeout=2s`: Request timeout (fast failure detection)
- `proxy_next_upstream`: Retry policy (error, timeout, http_5xx)
- `backup` directive: Green only receives traffic when Blue fails

### Environment Variables
| Variable | Description | Example |
|----------|-------------|---------|
| BLUE_IMAGE | Docker image for Blue | yimikaade/wonderful:devops-stage-two |
| GREEN_IMAGE | Docker image for Green | yimikaade/wonderful:devops-stage-two |
| ACTIVE_POOL | Default active pool | blue |
| RELEASE_ID_BLUE | Blue release identifier | blue-v1.0.0 |
| RELEASE_ID_GREEN | Green release identifier | green-v1.0.0 |
| PORT | Internal container port | 3000 |

## Endpoints

### Via Nginx (Main Service)
- `GET http://localhost:8080/version` - Get version and pool info
- `GET http://localhost:8080/healthz` - Health check

### Blue Instance (Direct Access)
- `GET http://localhost:8081/version` - Version info
- `POST http://localhost:8081/chaos/start?mode=error` - Simulate failure
- `POST http://localhost:8081/chaos/stop` - Stop simulation

### Green Instance (Direct Access)
- `GET http://localhost:8082/version` - Version info
- `POST http://localhost:8082/chaos/start?mode=error` - Simulate failure
- `POST http://localhost:8082/chaos/stop` - Stop simulation

## Project Structure
```
devops-stage2/
├── docker-compose.yml      # Container orchestration
├── nginx.conf              # Nginx reverse proxy configuration
├── .env                    # Environment variables (not in git)
├── .env.example            # Example environment file
├── test-failover.sh        # Automated test script
├── README.md               # This file
├── DECISION.md             # Implementation decisions (optional)
└── .gitignore              # Git ignore rules
```

## Troubleshooting

### Containers won't start
```bash
# Stop everything
docker-compose down -v

# Check for port conflicts
sudo lsof -ti:8080,8081,8082

# Start with logs
docker-compose up
```

### Failover not working
```bash
# Check Nginx logs
docker-compose logs nginx

# Check app logs
docker-compose logs app_blue
docker-compose logs app_green

# Verify Nginx config
docker exec devops-nginx nginx -t
```

### Headers not showing
```bash
# Use -i flag to see headers
curl -i http://localhost:8080/version

# Check if Nginx is stripping headers
docker-compose logs nginx | grep -i header
```

## Success Criteria
- ✅ All baseline requests return 200 with correct Blue headers
- ✅ Zero non-200 responses during failover
- ✅ ≥95% requests route to Green after chaos (typically 100%)
- ✅ Headers correctly reflect active pool (X-App-Pool, X-Release-Id)
- ✅ Automatic failover without manual intervention

## Maintenance

### Stop services
```bash
docker-compose down
```

### Stop and remove volumes
```bash
docker-compose down -v
```

### View logs
```bash
docker-compose logs -f
```

### Restart a single service
```bash
docker-compose restart nginx
```

## Author
**[Your Name]**  
DevOps Internship - Stage 2  
Date: October 28, 2025

## License
This project is for educational purposes as part of the HNG DevOps Internship.