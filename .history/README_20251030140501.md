# DevOps Stage 2 & 3 - Blue/Green Deployment with Observability

## Overview
This project implements a Blue/Green deployment pattern with automatic failover using Nginx and Docker Compose, extended with real-time monitoring and Slack alerting.

**Stage 2:** Blue/Green deployment with zero-downtime failover  
**Stage 3:** Observability, monitoring, and Slack alerts

---

## Stage 3 Features

### Observability
- âœ… Enhanced Nginx logging with pool tracking
- âœ… Structured logs with upstream status, latency, and pool info
- âœ… Shared log volume for monitoring services

### Real-Time Monitoring
- âœ… Python log-watcher service
- âœ… Sliding window error rate calculation
- âœ… Failover detection (Blue â†” Green)
- âœ… Configurable thresholds and cooldowns

### Slack Alerts
- âœ… Failover notifications
- âœ… High error rate warnings
- âœ… Recovery confirmations
- âœ… Startup notifications

---

## Quick Start

### Prerequisites
- Docker 20.10 or higher
- Docker Compose 1.29 or higher
- Slack workspace with webhook URL

### 1. Clone and Configure
```bash
git clone https://github.com/YOUR_USERNAME/devops-stage2.git
cd devops-stage2

# Copy environment template
cp .env.example .env

# Edit .env and add your Slack webhook URL
nano .env
```

### 2. Update .env File
```env
# Docker Images
BLUE_IMAGE=yimikaade/wonderful:devops-stage-two
GREEN_IMAGE=yimikaade/wonderful:devops-stage-two
ACTIVE_POOL=blue
RELEASE_ID_BLUE=blue-v1.0.0
RELEASE_ID_GREEN=green-v1.0.0
PORT=3000

# Stage 3 - Alerting
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
ERROR_RATE_THRESHOLD=2
WINDOW_SIZE=200
ALERT_COOLDOWN_SEC=300
```

### 3. Start Services
```bash
# Build and start all services
docker-compose up -d

# Check status
docker-compose ps

# View logs
docker-compose logs -f
```

### 4. Verify Setup
```bash
# Test endpoints
curl http://localhost:8080/version
curl http://localhost:8081/version
curl http://localhost:8082/version

# Check alert watcher logs
docker-compose logs alert_watcher
```

---

## Testing

### Test 1: Baseline (Stage 2)
```bash
# Run automated test
./test-failover.sh
```

Expected: âœ… ALL TESTS PASSED

### Test 2: Failover Alert (Stage 3)
```bash
# Trigger chaos on Blue
curl -X POST http://localhost:8081/chaos/start?mode=error

# Generate some traffic
for i in {1..10}; do
  curl http://localhost:8080/version
  sleep 0.5
done

# Check Slack for failover alert
# Expected: "ðŸ”„ Failover Detected! blue â†’ green"

# Stop chaos
curl -X POST http://localhost:8081/chaos/stop
```

### Test 3: High Error Rate Alert
```bash
# Generate errors on Green
curl -X POST http://localhost:8082/chaos/start?mode=error

# Trigger failover to Green
curl -X POST http://localhost:8081/chaos/start?mode=error

# Generate traffic (will hit Green with errors)
for i in {1..50}; do
  curl http://localhost:8080/version
done

# Check Slack for error rate alert
# Expected: "ðŸš¨ High Error Rate Alert! Error Rate: X%"

# Stop chaos
curl -X POST http://localhost:8081/chaos/stop
curl -X POST http://localhost:8082/chaos/stop
```

---

## Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `SLACK_WEBHOOK_URL` | (required) | Slack incoming webhook URL |
| `ERROR_RATE_THRESHOLD` | 2 | Error rate % that triggers alert |
| `WINDOW_SIZE` | 200 | Number of requests in sliding window |
| `ALERT_COOLDOWN_SEC` | 300 | Seconds between duplicate alerts |

### Tuning

**For more sensitive alerting:**
```env
ERROR_RATE_THRESHOLD=0.5
WINDOW_SIZE=100
ALERT_COOLDOWN_SEC=120
```

**For less noisy alerting:**
```env
ERROR_RATE_THRESHOLD=5
WINDOW_SIZE=500
ALERT_COOLDOWN_SEC=600
```

---

## Monitoring

### View Real-Time Logs
```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f alert_watcher
docker-compose logs -f nginx
docker-compose logs -f app_blue
```

### Check Nginx Logs with Pool Info
```bash
# View structured logs
docker-compose logs nginx | grep pool= | tail -20

# Count requests per pool
docker-compose logs nginx | grep -o 'pool="[^"]*"' | sort | uniq -c
```

### Monitor Alerts
```bash
# Watch for alerts being sent
docker-compose logs -f alert_watcher | grep "Slack alert"
```

---

## Troubleshooting

### Alerts Not Appearing in Slack
```bash
# Check watcher is running
docker-compose ps alert_watcher

# Check logs for errors
docker-compose logs alert_watcher

# Verify webhook URL
docker-compose exec alert_watcher env | grep SLACK_WEBHOOK_URL

# Test webhook manually
curl -X POST "YOUR_WEBHOOK_URL" \
  -H 'Content-Type: application/json' \
  -d '{"text":"Test"}'
```

### No Failover Detected
```bash
# Ensure chaos is triggered
curl -X POST http://localhost:8081/chaos/start?mode=error

# Generate traffic to trigger detection
for i in {1..20}; do curl http://localhost:8080/version; done

# Check watcher logs
docker-compose logs alert_watcher | grep -i failover
```

### High CPU Usage
```bash
# Check container stats
docker stats

# Rotate logs if too large
docker-compose exec nginx sh -c "echo > /var/log/nginx/access.log"
```

---

## Project Structure
```
devops-stage2/
â”œâ”€â”€ docker-compose.yml           # Container orchestration
â”œâ”€â”€ nginx.conf                   # Nginx configuration with custom logging
â”œâ”€â”€ watcher.py                   # Log monitoring and alerting script
â”œâ”€â”€ Dockerfile.watcher          # Watcher service Dockerfile
â”œâ”€â”€ requirements.txt            # Python dependencies
â”œâ”€â”€ .env                        # Environment variables (gitignored)
â”œâ”€â”€ .env.example                # Environment template
â”œâ”€â”€ test-failover.sh            # Automated failover test
â”œâ”€â”€ README.md                   # This file
â”œâ”€â”€ runbook.md                  # Operations runbook
â””â”€â”€ screenshots/                # Alert screenshots for submission
    â”œâ”€â”€ failover-alert.png
    â”œâ”€â”€ error-rate-alert.png
    â””â”€â”€ nginx-logs.png
```

---

## Maintenance

### Planned Downtime
```bash
# Stop alert watcher during maintenance
docker-compose stop alert_watcher

# Perform maintenance
# ...

# Restart watcher
docker-compose start alert_watcher
```

### Log Rotation
```bash
# Clear logs
docker-compose exec nginx sh -c "echo > /var/log/nginx/access.log"
docker-compose exec nginx sh -c "echo > /var/log/nginx/error.log"

# Restart watcher to reset state
docker-compose restart alert_watcher
```

---

## Runbook

For detailed operational procedures, see [runbook.md](./runbook.md)

Topics covered:
- Alert types and meanings
- Response procedures
- Escalation paths
- Emergency procedures
- Monitoring commands

---

## Screenshots

Alert screenshots are in the `screenshots/` directory:

1. **failover-alert.png** - Slack alert when Blue fails and Green takes over
2. **error-rate-alert.png** - Slack alert for high error rate
3. **nginx-logs.png** - Nginx logs showing structured log format

---

## Submission

**GitHub Repository:** https://github.com/YOUR_USERNAME/devops-stage2  
**Deployed On:** AWS EC2  
**Public IP:** YOUR_EC2_IP  
**Slack Workspace:** [Your workspace name]

---

## Author

**Name:** Temitope Joseph Olabode  
**Program:** HNG DevOps Internship - Stage 3  
**Date:** October 30, 2025

---

## License

Educational project for HNG DevOps Internship